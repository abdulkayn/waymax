{"ast":null,"code":"\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar sessionerror_1 = require(\"../sessionerror\");\n\nvar ConsumptionReportRequest = function ConsumptionReportRequest() {\n  (0, _classCallCheck3.default)(this, ConsumptionReportRequest);\n};\n\nvar ConsumptionReportEntry = function ConsumptionReportEntry() {\n  (0, _classCallCheck3.default)(this, ConsumptionReportEntry);\n};\n\nvar ReadHorizonPromise = function ReadHorizonPromise() {\n  (0, _classCallCheck3.default)(this, ReadHorizonPromise);\n};\n/**\n * @classdesc Provides read horizon management functionality\n */\n\n\nvar ReadHorizon = function () {\n  function ReadHorizon(services) {\n    (0, _classCallCheck3.default)(this, ReadHorizon);\n    this.services = services;\n    this.readHorizonRequests = new _map2.default();\n    this.readHorizonUpdateTimer = null;\n  }\n\n  (0, _createClass3.default)(ReadHorizon, [{\n    key: \"getReportInterval\",\n    value: function getReportInterval() {\n      return this.services.session.getConsumptionReportInterval().then(function (seconds) {\n        return seconds * 1000;\n      });\n    }\n  }, {\n    key: \"delayedSendReadHorizon\",\n    value: function delayedSendReadHorizon(delay) {\n      var _this = this;\n\n      if (this.readHorizonUpdateTimer !== null) {\n        return;\n      }\n\n      this.sendConsumptionReport(true);\n      this.readHorizonUpdateTimer = setTimeout(function () {\n        _this.sendConsumptionReport(false);\n      }, delay);\n    }\n  }, {\n    key: \"sendConsumptionReport\",\n    value: function sendConsumptionReport(keepTimer) {\n      var _this2 = this;\n\n      var reports = [];\n      var promises = new _map2.default();\n      this.readHorizonRequests.forEach(function (request, conversationSid) {\n        reports.push(request.entry);\n        promises.set(conversationSid, request.promises);\n      });\n\n      if (reports.length > 0) {\n        this.services.session.addCommand('consumptionReportV2', {\n          report: reports\n        }).then(function (response) {\n          return _this2.processConsumptionReportResponse(response, promises);\n        }).catch(function (err) {\n          return _this2.processConsumptionReportError(err, promises);\n        });\n      }\n\n      if (!keepTimer) {\n        this.readHorizonUpdateTimer = null;\n      }\n\n      this.readHorizonRequests.clear();\n    }\n  }, {\n    key: \"processConsumptionReportResponse\",\n    value: function processConsumptionReportResponse(response, promises) {\n      if (response && response.report && Array.isArray(response.report) && response.report.length > 0) {\n        response.report.forEach(function (entry) {\n          var responseEntry = entry;\n\n          if (promises.has(responseEntry.channelSid)) {\n            var unreadMessagesCount = null;\n\n            if (typeof responseEntry.unreadMessagesCount !== 'undefined' && responseEntry.unreadMessagesCount != null) {\n              unreadMessagesCount = responseEntry.unreadMessagesCount;\n            }\n\n            promises.get(responseEntry.channelSid).forEach(function (promise) {\n              return promise.resolve(unreadMessagesCount);\n            });\n            promises.delete(responseEntry.channelSid);\n          }\n        });\n      }\n\n      this.processConsumptionReportError(new sessionerror_1.SessionError('Error while setting LastReadMessageIndex', null), promises);\n    }\n  }, {\n    key: \"processConsumptionReportError\",\n    value: function processConsumptionReportError(err, promises) {\n      promises.forEach(function (conversationPromises) {\n        return conversationPromises.forEach(function (promise) {\n          return promise.reject(err);\n        });\n      });\n    }\n    /**\n     * Updates read horizon value without any checks\n     */\n\n  }, {\n    key: \"updateLastReadMessageIndexForConversation\",\n    value: function updateLastReadMessageIndexForConversation(conversationSid, messageIdx) {\n      var _this3 = this;\n\n      return new _promise2.default(function (resolve, reject) {\n        _this3.addPendingConsumptionHorizonRequest(conversationSid, {\n          channelSid: conversationSid,\n          messageIdx: messageIdx\n        }, {\n          resolve: resolve,\n          reject: reject\n        });\n\n        _this3.getReportInterval().then(function (delay) {\n          return _this3.delayedSendReadHorizon(delay);\n        });\n      });\n    }\n    /**\n     * Move read horizon forward\n     */\n\n  }, {\n    key: \"advanceLastReadMessageIndexForConversation\",\n    value: function advanceLastReadMessageIndexForConversation(conversationSid, messageIdx, currentConversationLastReadIndex) {\n      var _this4 = this;\n\n      var currentHorizon = this.readHorizonRequests.get(conversationSid);\n      return new _promise2.default(function (resolve, reject) {\n        if (currentHorizon && currentHorizon.entry) {\n          if (currentHorizon.entry.messageIdx >= messageIdx) {\n            _this4.addPendingConsumptionHorizonRequest(conversationSid, currentHorizon.entry, {\n              resolve: resolve,\n              reject: reject\n            });\n          } else {\n            _this4.addPendingConsumptionHorizonRequest(conversationSid, {\n              channelSid: conversationSid,\n              messageIdx: messageIdx\n            }, {\n              resolve: resolve,\n              reject: reject\n            });\n          }\n        } else {\n          if (currentConversationLastReadIndex !== null && messageIdx < currentConversationLastReadIndex) {\n            _this4.addPendingConsumptionHorizonRequest(conversationSid, {\n              channelSid: conversationSid,\n              messageIdx: currentConversationLastReadIndex\n            }, {\n              resolve: resolve,\n              reject: reject\n            });\n          } else {\n            _this4.addPendingConsumptionHorizonRequest(conversationSid, {\n              channelSid: conversationSid,\n              messageIdx: messageIdx\n            }, {\n              resolve: resolve,\n              reject: reject\n            });\n          }\n        }\n\n        _this4.getReportInterval().then(function (delay) {\n          return _this4.delayedSendReadHorizon(delay);\n        });\n      });\n    }\n  }, {\n    key: \"addPendingConsumptionHorizonRequest\",\n    value: function addPendingConsumptionHorizonRequest(conversationSid, entry, promise) {\n      if (this.readHorizonRequests.has(conversationSid)) {\n        var request = this.readHorizonRequests.get(conversationSid);\n        request.entry = entry;\n        request.promises.push(promise);\n      } else {\n        this.readHorizonRequests.set(conversationSid, {\n          entry: entry,\n          promises: [promise]\n        });\n      }\n    }\n  }]);\n  return ReadHorizon;\n}();\n\nexports.ReadHorizon = ReadHorizon;","map":{"version":3,"sources":["/Users/abdulkhan/Documents/waymax/Waymax/node_modules/@twilio/conversations/browser/services/readhorizon.js"],"names":["_promise","require","_promise2","_interopRequireDefault","_map","_map2","_createClass2","_createClass3","_classCallCheck2","_classCallCheck3","obj","__esModule","default","Object","defineProperty","exports","value","sessionerror_1","ConsumptionReportRequest","ConsumptionReportEntry","ReadHorizonPromise","ReadHorizon","services","readHorizonRequests","readHorizonUpdateTimer","key","getReportInterval","session","getConsumptionReportInterval","then","seconds","delayedSendReadHorizon","delay","_this","sendConsumptionReport","setTimeout","keepTimer","_this2","reports","promises","forEach","request","conversationSid","push","entry","set","length","addCommand","report","response","processConsumptionReportResponse","catch","err","processConsumptionReportError","clear","Array","isArray","responseEntry","has","channelSid","unreadMessagesCount","get","promise","resolve","delete","SessionError","conversationPromises","reject","updateLastReadMessageIndexForConversation","messageIdx","_this3","addPendingConsumptionHorizonRequest","advanceLastReadMessageIndexForConversation","currentConversationLastReadIndex","_this4","currentHorizon"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _promise = require(\"babel-runtime/core-js/promise\");\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar sessionerror_1 = require(\"../sessionerror\");\n\nvar ConsumptionReportRequest = function ConsumptionReportRequest() {\n    (0, _classCallCheck3.default)(this, ConsumptionReportRequest);\n};\n\nvar ConsumptionReportEntry = function ConsumptionReportEntry() {\n    (0, _classCallCheck3.default)(this, ConsumptionReportEntry);\n};\n\nvar ReadHorizonPromise = function ReadHorizonPromise() {\n    (0, _classCallCheck3.default)(this, ReadHorizonPromise);\n};\n/**\n * @classdesc Provides read horizon management functionality\n */\n\n\nvar ReadHorizon = function () {\n    function ReadHorizon(services) {\n        (0, _classCallCheck3.default)(this, ReadHorizon);\n\n        this.services = services;\n        this.readHorizonRequests = new _map2.default();\n        this.readHorizonUpdateTimer = null;\n    }\n\n    (0, _createClass3.default)(ReadHorizon, [{\n        key: \"getReportInterval\",\n        value: function getReportInterval() {\n            return this.services.session.getConsumptionReportInterval().then(function (seconds) {\n                return seconds * 1000;\n            });\n        }\n    }, {\n        key: \"delayedSendReadHorizon\",\n        value: function delayedSendReadHorizon(delay) {\n            var _this = this;\n\n            if (this.readHorizonUpdateTimer !== null) {\n                return;\n            }\n            this.sendConsumptionReport(true);\n            this.readHorizonUpdateTimer = setTimeout(function () {\n                _this.sendConsumptionReport(false);\n            }, delay);\n        }\n    }, {\n        key: \"sendConsumptionReport\",\n        value: function sendConsumptionReport(keepTimer) {\n            var _this2 = this;\n\n            var reports = [];\n            var promises = new _map2.default();\n            this.readHorizonRequests.forEach(function (request, conversationSid) {\n                reports.push(request.entry);\n                promises.set(conversationSid, request.promises);\n            });\n            if (reports.length > 0) {\n                this.services.session.addCommand('consumptionReportV2', { report: reports }).then(function (response) {\n                    return _this2.processConsumptionReportResponse(response, promises);\n                }).catch(function (err) {\n                    return _this2.processConsumptionReportError(err, promises);\n                });\n            }\n            if (!keepTimer) {\n                this.readHorizonUpdateTimer = null;\n            }\n            this.readHorizonRequests.clear();\n        }\n    }, {\n        key: \"processConsumptionReportResponse\",\n        value: function processConsumptionReportResponse(response, promises) {\n            if (response && response.report && Array.isArray(response.report) && response.report.length > 0) {\n                response.report.forEach(function (entry) {\n                    var responseEntry = entry;\n                    if (promises.has(responseEntry.channelSid)) {\n                        var unreadMessagesCount = null;\n                        if (typeof responseEntry.unreadMessagesCount !== 'undefined' && responseEntry.unreadMessagesCount != null) {\n                            unreadMessagesCount = responseEntry.unreadMessagesCount;\n                        }\n                        promises.get(responseEntry.channelSid).forEach(function (promise) {\n                            return promise.resolve(unreadMessagesCount);\n                        });\n                        promises.delete(responseEntry.channelSid);\n                    }\n                });\n            }\n            this.processConsumptionReportError(new sessionerror_1.SessionError('Error while setting LastReadMessageIndex', null), promises);\n        }\n    }, {\n        key: \"processConsumptionReportError\",\n        value: function processConsumptionReportError(err, promises) {\n            promises.forEach(function (conversationPromises) {\n                return conversationPromises.forEach(function (promise) {\n                    return promise.reject(err);\n                });\n            });\n        }\n        /**\n         * Updates read horizon value without any checks\n         */\n\n    }, {\n        key: \"updateLastReadMessageIndexForConversation\",\n        value: function updateLastReadMessageIndexForConversation(conversationSid, messageIdx) {\n            var _this3 = this;\n\n            return new _promise2.default(function (resolve, reject) {\n                _this3.addPendingConsumptionHorizonRequest(conversationSid, { channelSid: conversationSid, messageIdx: messageIdx }, { resolve: resolve, reject: reject });\n                _this3.getReportInterval().then(function (delay) {\n                    return _this3.delayedSendReadHorizon(delay);\n                });\n            });\n        }\n        /**\n         * Move read horizon forward\n         */\n\n    }, {\n        key: \"advanceLastReadMessageIndexForConversation\",\n        value: function advanceLastReadMessageIndexForConversation(conversationSid, messageIdx, currentConversationLastReadIndex) {\n            var _this4 = this;\n\n            var currentHorizon = this.readHorizonRequests.get(conversationSid);\n            return new _promise2.default(function (resolve, reject) {\n                if (currentHorizon && currentHorizon.entry) {\n                    if (currentHorizon.entry.messageIdx >= messageIdx) {\n                        _this4.addPendingConsumptionHorizonRequest(conversationSid, currentHorizon.entry, { resolve: resolve, reject: reject });\n                    } else {\n                        _this4.addPendingConsumptionHorizonRequest(conversationSid, { channelSid: conversationSid, messageIdx: messageIdx }, { resolve: resolve, reject: reject });\n                    }\n                } else {\n                    if (currentConversationLastReadIndex !== null && messageIdx < currentConversationLastReadIndex) {\n                        _this4.addPendingConsumptionHorizonRequest(conversationSid, { channelSid: conversationSid, messageIdx: currentConversationLastReadIndex }, { resolve: resolve, reject: reject });\n                    } else {\n                        _this4.addPendingConsumptionHorizonRequest(conversationSid, { channelSid: conversationSid, messageIdx: messageIdx }, { resolve: resolve, reject: reject });\n                    }\n                }\n                _this4.getReportInterval().then(function (delay) {\n                    return _this4.delayedSendReadHorizon(delay);\n                });\n            });\n        }\n    }, {\n        key: \"addPendingConsumptionHorizonRequest\",\n        value: function addPendingConsumptionHorizonRequest(conversationSid, entry, promise) {\n            if (this.readHorizonRequests.has(conversationSid)) {\n                var request = this.readHorizonRequests.get(conversationSid);\n                request.entry = entry;\n                request.promises.push(promise);\n            } else {\n                this.readHorizonRequests.set(conversationSid, { entry: entry, promises: [promise] });\n            }\n        }\n    }]);\n    return ReadHorizon;\n}();\n\nexports.ReadHorizon = ReadHorizon;"]},"metadata":{},"sourceType":"script"}